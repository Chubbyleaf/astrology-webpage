<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>D3 Tree Diagram</title>
  <script src="https://d3js.org/d3.v5.min.js"></script>
</head>

<body>

  <script>
    // Sample data for the tree
    const treeData = [{
        name: "Root1",
        type: 'emotion',
        children: [{
            name: "Node1.1",
            type: "star"
          },
          {
            name: "Node1.2",
            type: "star"
          },
          {
            name: "Node1.3",
            type: "star"

          },
        ]
      },
      {
        name: "Root2",
        type: "emotion",

        children: [{
            name: "Node1.1",
            type: "star"

          },
          {
            name: "Node2.2",
            type: "star"

          },
          {
            name: "Node3.3",
            type: "star"

          },
        ]
      },

      {
        name: "Root3",
        type: "poet",

        children: [{
            name: "Node1.1",
            type: "star"

          },
          {
            name: "Node2.2",
            type: "star"

          },
          {
            name: "Node3.3",
            type: "star"

          },
        ]
      }, {
        name: "Root4",
        type: "poet",

        children: [{
            name: "Node1.1",
            type: "star"

          },
          {
            name: "Node2.2",
            type: "star"

          },
          {
            name: "Node3.3",
            type: "star"

          },
        ]
      }, {
        name: "Root5",
        type: "poet",

        children: [{
            name: "Node1.1",
            type: "star"

          },
          {
            name: "Node2.2",
            type: "star"

          },
          {
            name: "Node3.3",
            type: "star"

          },
        ]
      },
    ];

    // Set up dimensions

    var emotionx = 100
    var poetx = 100
    const width = 600;
    const height = 1000;

    // Create a tree layout
    const tree = d3.tree().size([height, width]);

    // Append an SVG to the body
    const svg = d3.select("body").append("svg")
      .attr("width", width)
      .attr("height", height)
      .append("g")
      .attr("transform", "translate(40,40)"); // Add a margin for better visualization

    // Create hierarchical data structure
    // const root = d3.hierarchy({
    //   children: treeData
    // });
    // const treeRoot = tree(root);

    // // Add links
    // // 添加连线
    // svg.selectAll(".link")
    //   .data(root.links())
    //   .enter().append("path")
    //   .attr("class", "link")
    //   .attr("d", d3.linkVertical()
    //     .x(d => d.x)
    //     .y(d => d.y)
    //   );

    // // 添加节点
    // const nodes = svg.selectAll(".node")
    //   .data(root.descendants())
    //   .enter().append("g")
    //   .attr("class", "node")
    //   .attr("transform", d => {
    //     console.log(d, "jiedian")
    //     // 如果是 "poet" 节点，则固定在最下层
    //     if (d.data.type === "poet") {
    //       poetx += 50
    //       return `translate(${poetx}, 200)`;
    //     }
    //     // 如果是 "emotion" 节点，则固定在最上层
    //     if (d.data.type === "emotion") {
    //       emotionx += 50
    //       return `translate(${emotionx}, 0)`;
    //     }
    //     // 对于其他节点（"star"），固定在中间一层
    //     return `translate(${d.x}, 100)`;
    //   });

    // 根据类型分组
    const groupedData = d3.nest()
      .key(d => d.type)
      .entries(d.children);

    // 计算每个分组的平均位置
    groupedData.forEach(group => {
      const averageX = d3.mean(group.values, d => d.x);
      const averageY = d3.mean(group.values, d => d.y);

      // 更新每个节点的位置
      group.values.forEach(d => {
        d.x = averageX;
        d.y = averageY;
      });
    });

    // 重新构建树状图
    const root = d3.hierarchy(data);
    tree(root);

    // 添加连线
    svg.selectAll(".link")
      .data(root.links())
      .enter().append("path")
      .attr("class", "link")
      .attr("d", d3.linkVertical()
        .x(d => d.x)
        .y(d => d.y)
      );

    // 添加节点
    const nodes = svg.selectAll(".node")
      .data(root.descendants())
      .enter().append("g")
      .attr("class", "node")
      .attr("transform", d => `translate(${d.x},${d.y})`);

    nodes.append("circle")
      .attr("r", 5);

    nodes.append("text")
      .attr("dy", "0.31em")
      .attr("x", d => d.children ? -8 : 8)
      .style("text-anchor", d => d.children ? "end" : "start")
      .text(d => d.data.name);
  </script>

  <style>
    .link {
      fill: none;
      stroke: #ccc;
      stroke-width: 1.5px;
    }

    .node circle {
      fill: #fff;
      stroke: steelblue;
      stroke-width: 1.5px;
    }

    .node text {
      font-size: 10px;
    }
  </style>

</body>

</html>